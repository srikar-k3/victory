version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline || npm ci
        # Capture secrets into a server-only .env.local so Next can read them at build time
        - |
          cat > .env.local <<EOF
          SMTP_HOST=$SMTP_HOST
          SMTP_PORT=$SMTP_PORT
          SMTP_USER=$SMTP_USER
          SMTP_PASS=$SMTP_PASS
          SMTP_SECURE=$SMTP_SECURE
          SMTP_FROM=$SMTP_FROM
          CONTACT_TO=$CONTACT_TO
          NEXT_PUBLIC_SUBSTACK_URL=$NEXT_PUBLIC_SUBSTACK_URL
          EOF
        # Also bake a JSON that we import ONLY in server code as a fallback
        - mkdir -p src/lib
        - |
          cat > src/lib/bakedEnv.json <<EOF
          {
            "SMTP_HOST": "$SMTP_HOST",
            "SMTP_PORT": "$SMTP_PORT",
            "SMTP_USER": "$SMTP_USER",
            "SMTP_PASS": "$SMTP_PASS",
            "SMTP_SECURE": "$SMTP_SECURE",
            "SMTP_FROM": "$SMTP_FROM",
            "CONTACT_TO": "$CONTACT_TO"
          }
          EOF
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
